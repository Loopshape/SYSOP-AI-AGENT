#!/usr/bin/env bash

# ai - Main Dispatcher for the SYSOP-AI-AGENT Platform
# Version 10.1 - Fixed robust path discovery

# --- Project Root & Source Loading ---
# FIX: Robustly find the script's own directory, then determine the project root.
# This ensures that no matter where the script is called from (e.g., via a symlink in /usr/local/bin),
# it can always locate its own modules in the 'src' directory.
SOURCE=${BASH_SOURCE[0]}
while [ -L "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SCRIPT_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
PROJECT_ROOT=$(cd "$SCRIPT_DIR/.." && pwd)

# Source all the necessary modules using the now-correct PROJECT_ROOT
source "$PROJECT_ROOT/src/utils.sh"
source "$PROJECT_ROOT/src/config.sh"
source "$PROJECT_ROOT/src/tools.sh"
source "$PROJECT_ROOT/src/core.sh"

# --- MAIN DISPATCHER ---
main() {
    # On first run, or if config is missing, guide the user.
    if ! load_config_values; then
        log_warn "Configuration file not found or invalid at '$CONFIG_FILE'."
        log_info "Please run the installer to create a default configuration:"
        log_info "bash $PROJECT_ROOT/install.sh"
        exit 1
    fi
    
    # Ensure core databases exist
    init_db
    
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    # Handle top-level commands
    case "$1" in
        --setup)
            bash "$PROJECT_ROOT/install.sh"
            ;;
        --help|-h)
            show_help
            ;;
        # --- Direct Action Modes ---
        git)
            shift
            git_operation "${1:-status}" "${2:-.}"
            ;;
        memory)
            shift
            memory_operation "${1:-search}" "${*:-}"
            ;;
        config)
            shift
            config_operation "${1:-view}" "${2:-}" "${3:-}"
            ;;
        # --- Agent Modes ---
        agent)
            shift
            run_coder_agi_agent "$@"
            ;;
        triumvirate)
            shift
            run_triumvirate_agent "$@"
            ;;
        *)
            # Default to the primary Coder-AGI agent for any other prompt
            run_coder_agi_agent "$@"
            ;;
    esac
}

# --- ENTRY POINT ---
main "$@"